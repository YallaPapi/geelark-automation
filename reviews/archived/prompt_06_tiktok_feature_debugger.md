# Prompt 6 - TikTok Poster Feature Debugger

**Goal:** Make Claude fully grok the TikTok feature, architecture, and failure mode before touching code.

---

You are a senior Python automation engineer working on a social media posting system that already works reliably for Instagram and is being extended to TikTok.

You are given a single XML digest of the codebase generated by Repomix (`reviews/repomix-output-YallaPapi-geelark-automation.xml`). This digest contains the full text of key files, including but not limited to:
- `posters/__init__.py` (poster factory)
- `posters/base_poster.py` (`BasePoster`, `PostResult`)
- `posters/instagram_poster.py` (adapter around `SmartInstagramPoster`)
- `posters/tiktok_poster.py` (TikTok implementation)
- `post_reel_smart.py` (working Instagram flow with Claude-driven UI navigation and screenshot analysis)
- `parallel_orchestrator.py`, `parallel_worker.py`, and campaign config/analysis docs

## Context & Requirements
- The Instagram path is stable and production-tested.
- TikTok support was added reusing the same patterns (factory + poster + Claude UI navigation) but is currently broken.
- TikTok symptoms:
  - Claude navigation loop in `TikTokPoster.post()` hits `max_steps` (default 30) without successfully completing the post.
  - TikTok poster does not capture screenshots on failure, unlike the Instagram flow which uses `analyze_failure_screenshot()` in `post_reel_smart.py`.
- TikTok navigation uses a Claude prompt `TIKTOK_NAVIGATION_PROMPT` and methods like `_analyze_ui()` and `_execute_action()`.

## Task
1. From the digest, locate and summarize:
   - The `BasePoster` interface and `PostResult` dataclass in `posters/base_poster.py`.
   - The Instagram poster adapter in `posters/instagram_poster.py` and how it delegates to `SmartInstagramPoster`, especially:
     - How errors, screenshots, and `last_error_type` / `last_error_message` / `last_screenshot_path` are surfaced.
     - The pattern of the Instagram navigation loop and how failure is handled, including `analyze_failure_screenshot()` in `post_reel_smart.py`.
   - The TikTok poster implementation in `posters/tiktok_poster.py`, focusing on:
     - State variables used for navigation (`_video_uploaded`, `_caption_entered`, `_post_clicked`, etc.).
     - The Claude navigation loop (where `max_steps` is used).
     - The TikTok Claude prompt (`TIKTOK_NAVIGATION_PROMPT`) and its expected JSON action schema.
2. Identify and clearly list the **specific reasons** why the TikTok navigation currently fails to complete within `max_steps`. Consider at least:
   - Mismatches between `TIKTOK_NAVIGATION_PROMPT` and the actual UI element data produced by `_dump_ui()` / `_format_elements_for_claude()`.
   - Missing or incorrect state updates (`_video_uploaded`, `_caption_entered`, `_post_clicked`, `video_selected`) based on Claude's JSON response.
   - Missing "done" / confirmation detection logic after tapping Post (e.g., not checking for upload/posted confirmation in the UI text).
   - Differences between error handling in Instagram (where `SmartInstagramPoster` + `analyze_failure_screenshot()` provide rich feedback) vs TikTok.
3. Identify **observability gaps** for the TikTok path:
   - Where and how Instagram captures screenshots and error context.
   - What TikTok currently does not capture (screenshots, UI dumps, logs) that makes debugging the navigation loop difficult.

## Output Format
- Section 1: "Architecture summary" - 5-10 bullet points.
- Section 2: "Root causes for TikTok navigation failure" - bullet list of concrete issues, each referencing the relevant functions/variables (with filenames).
- Section 3: "Observability gaps" - bullet list of missing elements for TikTok.

Only use information contained in the digest; do not invent new modules or external services.
